<script>
  const layoutSelect = document.getElementById('layout');
  const videoGrid = document.getElementById('video-grid');
  const controls = document.getElementById('controls');
  const title = document.getElementById('title');
  const checkboxes = [
    document.getElementById('stream1'),
    document.getElementById('stream2'),
    document.getElementById('stream3'),
    document.getElementById('stream4')
  ];

  function updateLayout() {
    const layout = layoutSelect.value;
    videoGrid.className = `layout-${layout}`;
    updateVisibility();
  }

  function updateVisibility() {
    checkboxes.forEach((cb, i) => {
      const container = document.getElementById(`container${i + 1}`);
      container.style.display = cb.checked ? 'flex' : 'none';
    });

    // Force grid recalculation so all visible streams are even
    videoGrid.style.display = 'none';
    void videoGrid.offsetHeight; // trigger reflow
    videoGrid.style.display = 'grid';
  }

  function updateStream(num) {
    const container = document.getElementById(`container${num}`);
    const embed = document.getElementById(`embed${num}`).value.trim();

    if (embed) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = embed;

      const iframe = tempDiv.querySelector('iframe');
      if (iframe) {
        // Ensure autoplay and sizing consistency
        iframe.setAttribute(
          'allow',
          'autoplay; encrypted-media; picture-in-picture'
        );
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';

        container.innerHTML = ''; // Clear old iframe
        container.appendChild(iframe);
        container.style.display = 'flex';
      }
    }
    updateVisibility();
  }

  layoutSelect.addEventListener('change', updateLayout);
  checkboxes.forEach(cb => cb.addEventListener('change', updateVisibility));

  title.addEventListener('click', () => {
    controls.style.display =
      controls.style.display === 'flex' ? 'none' : 'flex';
  });

  // Initialize correct layout & scaling
  updateLayout();
</script>
